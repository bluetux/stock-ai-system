{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2>ğŸ“ˆ ìˆ˜ì§‘ëœ ì£¼ê°€ ë³´ê¸°</h2>

    <div class="row">
        <!-- âœ… ì™¼ìª½ ì‚¬ì´ë“œë°” -->
        <div class="col-md-3">
            <h4>ğŸ“Œ ì£¼ì‹ ê·¸ë£¹</h4>
            <ul class="list-group">
                {% for group in stock_groups %}
                <li class="list-group-item">
                    <a href="#" onclick="filterStocks({{ group[0] }})">{{ group[1] }}</a>
                </li>
                {% endfor %}
            </ul>

            <h4 class="mt-3">ğŸ“Š ê°œë³„ ì£¼ì‹</h4>
            <ul class="list-group">
                {% for stock in stocks %}
                <li class="list-group-item">
                    <a href="#" onclick="loadStockData('{{ stock[0] }}')">{{ stock[1] }}</a>
                </li>
                {% endfor %}
            </ul>

            <button class="btn btn-secondary mt-3" onclick="location.href='/settings'">âš™ ì„¤ì •</button>
        </div>

        <!-- âœ… ì˜¤ë¥¸ìª½ ë©”ì¸ ì½˜í…ì¸  -->
        <div class="col-md-9">
            <h3 id="stock-title">ğŸ“‰ ì„ íƒí•œ ì£¼ì‹</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>í‹°ì»¤</th>
                        <th>ì´ë¦„</th>
                        <th>ìµœê·¼ ê°€ê²©</th>
                        <th>ìˆ˜ì§‘ ë‚ ì§œ</th>
                    </tr>
                </thead>
                <tbody id="stock-data">
                    <tr>
                        <td colspan="4" class="text-center">ë°ì´í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”</td>
                    </tr>
                </tbody>
            </table>

            <!-- âœ… ì£¼ê°€ ë³€ë™ ê·¸ë˜í”„ -->
            <canvas id="stockChart"></canvas>
        </div>
    </div>
</div>

<!-- âœ… JS ì½”ë“œ -->
<script>
    function loadStockData(ticker) {
        fetch(`/api/stock/${ticker}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById("stock-title").innerText = "ğŸ“‰ " + data.ticker;
                let tableBody = document.getElementById("stock-data");
                tableBody.innerHTML = "";

                data.history.forEach(row => {
                    let tr = document.createElement("tr");
                    tr.innerHTML = `<td>${data.ticker}</td>
                                <td>${data.name}</td>
                                <td>${row.price}</td>
                                <td>${row.date}</td>`;
                    tableBody.appendChild(tr);
                });

                updateChart(data.history);
            });
    }

    function updateChart(history) {
        let ctx = document.getElementById("stockChart").getContext("2d");
        let dates = history.map(row => row.date);
        let prices = history.map(row => row.price);

        if (window.stockChartInstance) {
            window.stockChartInstance.destroy();
        }

        window.stockChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: "ì£¼ê°€ ë³€í™”",
                    borderColor: "blue",
                    data: prices,
                    fill: false
                }]
            }
        });
    }
</script>

{% endblock %}